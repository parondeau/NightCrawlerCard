// Generated by CoffeeScript 1.6.2
(function() {
  this.barsList = null;

  (function(App) {
    var kikItCard, linkToFoursquare, onSearch, restoreAppSession, venue;

    onSearch = function(page) {
      var query;

      query = $(page).find('#venueSearchQuery').val();
      if (query) {
        return getBars(query, function(err, venues) {
          var listitems;

          $(".app-section").first().removeClass("invalid");
          this.barsList = venues;
          listitems = "";
          venues.forEach(function(venue, index) {
            return listitems += render('venue_listitem', {
              index: index,
              name: venue.name,
              id: venue.id,
              location: venue.location.address
            });
          });
          $(page).find("#venuesList").html(listitems);
          return lazyLoad();
        });
      }
    };
    kikItCard = function(venue) {
      if (cards.kik) {
        return cards.kik.send({
          title: venue.name,
          text: venue.description,
          pic: venue.photo,
          noForward: false,
          data: {
            venue: venue
          }
        });
      }
    };
    linkToFoursquare = function(venue) {
      return window.location = venue.url;
    };
    restoreAppSession = function() {
      var err;

      try {
        return App.restore();
      } catch (_error) {
        err = _error;
        return App.load("home");
      }
    };
    App.populator("home", function(page) {
      $(page).find('#venueSearchButton').on('click', function(event) {
        return onSearch(page);
      });
      if (navigator.geolocation) {
        return navigator.geolocation.getCurrentPosition(function(success) {
          return console.log(success);
        }, function(err) {
          return console.log(err);
        });
      }
    });
    App.populator("venuePage", function(page, venue) {
      var done, venueIndex;

      console.log(venue);
      venueIndex = venue.index;
      done = function(venue) {
        var _this = this;

        $(page).find('#venueName').text(venue.name);
        $(page).find('#venueDesc').text(venue.description);
        $(page).find('#venuePhoto')[0].src = venue.photo;
        $(page).find('#kikBtn').on('click', function() {
          return kikItCard(venue);
        });
        return $(page).find('#venueName').on('click', function() {
          return linkToFoursquare(venue);
        });
      };
      if (venue.external) {
        $(page).find('#backToHome').on('click', function(e) {
          return App.load('home');
        });
      } else if (barsList) {
        venue = barsList[venueIndex];
        if (!venue.description || !venue.photo) {
          getBarData(venueIndex, function(err, venue) {
            return done(venue);
          });
        }
      }
      return done(venue);
    });
    if (!cards.kik || !cards.kik.message) {
      return restoreAppSession();
    } else {
      venue = cards.kik.message.venue;
      console.log(cards.kik.message.venue.name);
      return App.load("venuePage", {
        external: true,
        name: venue.name,
        photo: venue.photo,
        description: venue.description,
        location: venue.location
      });
    }
  })(App);

}).call(this);
